<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Project Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    h1[contenteditable], .project-title[contenteditable] { outline: none; border-bottom: 1px dashed #ccc; padding: 0.2rem; }
    #header { display: flex; align-items: center; margin-bottom: 1rem; }
    #header h1 { flex: 1; margin: 0; }
    button { cursor: pointer; }
    .project-container { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; }
    .project-header { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .project-header h2 { flex: 1; margin: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #f4f4f4; }
    input[type="text"], input[type="date"], select, input[type="number"] { width: 100%; box-sizing: border-box; }
    .delete-btn { background: #e74c3c; color: #fff; border: none; padding: 4px 8px; border-radius: 3px; }
    .add-task-btn, .toggle-btn { margin-left: 4px; background: #2ecc71; color: #fff; border: none; padding: 4px 8px; border-radius: 3px; }
    .toggle-btn { background: #3498db; }
    .drag-handle { cursor: move; }
    .days-left { cursor: pointer; }
    .no-alert-icon { width:16px; height:16px; vertical-align:middle; margin-left:4px; }
    @keyframes flash-yellow { 0%,100%{background:transparent;} 50%{background:yellow;} }
    @keyframes flash-red    { 0%,100%{background:transparent;} 50%{background:red;} }
    .flash-warn  { animation: flash-yellow 1s infinite; }
    .flash-alarm { animation: flash-red    1s infinite; }
    td.priority-low    { background: #9b59b6 !important; }
    td.priority-medium { background: yellow   !important; }
    td.priority-high   { background: red      !important; }
    tr.in-progress     { border: 2px solid #39ff14 !important; }
    tr.on-hold         { background: lightgray !important; color: white !important; text-decoration: none !important; }
    tr.done            { color: lightgray !important; text-decoration: line-through !important; }
    #dueSoonToggle { position: fixed; bottom: 1rem; right: 1rem; padding: 6px 12px; background: #3498db; color: #000; border: none; border-radius: 4px; z-index: 1001; }
    #dueSoonPanel  { position: fixed; bottom: 0; left: 0; width: 100%; height: 0; background: #fff; overflow-y: auto; border-top: 1px solid #ccc; transition: height 0.3s ease; }
    #dueSoonPanel.open { height: 30%; }
    #dueSoonTable { width: 100%; border-collapse: collapse; }
    #dueSoonTable th, #dueSoonTable td { border: 1px solid #ccc; padding: 0.5rem; }
  </style>
</head>
<body>
  <div id="header">
    <h1 contenteditable id="mainTitle">Project Tracker</h1>
    <button id="newProjectBtn">+ New Project</button>
  </div>
  <div id="projects"></div>
  <button id="dueSoonToggle">Tasks Due Soon (0)</button>
  <div id="dueSoonPanel">
    <h3>Tasks Due Soon</h3>
    <table id="dueSoonTable">
      <thead><tr><th>Task</th><th>Days Left</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    const warnDays = 14, alarmDays = 7;
    const projectsDiv = document.getElementById('projects');
    const dueToggle   = document.getElementById('dueSoonToggle');
    const duePanel    = document.getElementById('dueSoonPanel');
    let hueCounter = 0;
    function getUniqueHue() { hueCounter++; return (hueCounter * 137.508) % 360; }
    function daysLeft(d) { return Math.ceil((new Date(d) - new Date()) / (1000*60*60*24)); }

    function saveToStorage() {
      const data = [];
      document.querySelectorAll('.project-container').forEach(pc => {
        const proj = { title: pc.querySelector('.project-title').textContent, tasks: [] };
        pc.querySelectorAll('.task-row').forEach(tr => {
          const t = {
            name: tr.cells[1].textContent,
            due: tr.querySelector('input[type="date"]').value,
            status: tr.querySelector('select.task-status').value,
            priority: tr.querySelector('select.task-priority').value,
            estimate: parseInt(tr.querySelector('.task-estimate').textContent,10)||0,
            notes: tr.cells[6].textContent,
            hue: tr.dataset.hue,
            subtasks: []
          };
          tr.nextElementSibling.querySelectorAll('.subtask-entry').forEach(str => {
            t.subtasks.push({
              name: str.cells[0].textContent,
              due: str.querySelector('input[type="date"]').value,
              status: str.querySelector('select.subtask-status').value,
              priority: str.querySelector('select.subtask-priority').value,
              notes: str.cells[4].textContent
            });
          });
          proj.tasks.push(t);
        });
        data.push(proj);
      });
      localStorage.setItem('myTrackerData', JSON.stringify(data));
    }

    function loadFromStorage() {
      const raw = localStorage.getItem('myTrackerData'); if (!raw) return;
      try {
        const projs = JSON.parse(raw);
        let count = 0;
        projs.forEach(p => {
          createProject();
          const pc = projectsDiv.lastElementChild;
          pc.querySelector('.project-title').textContent = p.title;
          p.tasks.forEach(t => { addTask(pc, t); count++; });
        });
        hueCounter = count;
      } catch (e) { console.error('Load error', e); }
    }

    function attachDaysLeftHandlers() {
      document.querySelectorAll('.days-left').forEach(span => {
        if (span._linked) return; span._linked = true;
        span.addEventListener('click', () => {
          span.dataset.flashDisabled = span.dataset.flashDisabled === 'true' ? 'false' : 'true';
          if (span.dataset.flashDisabled === 'true') {
            const img = document.createElement('img'); img.src = 'NoAlert_ICON.png'; img.className = 'no-alert-icon'; span.parentNode.appendChild(img);
          } else {
            const icon = span.parentNode.querySelector('.no-alert-icon'); if (icon) icon.remove();
          }
          applyFlashes();
        });
      });
    }

    function applyRowStyles() {
      document.querySelectorAll('.task-row, .subtask-entry').forEach(tr => {
        const status = tr.querySelector('select.task-status, select.subtask-status').value;
        tr.classList.toggle('on-hold', status === 'On Hold');
        tr.classList.toggle('done',    status === 'Done');
        tr.classList.toggle('in-progress', status === 'In Progress');
        const span = tr.querySelector('.days-left');
        if (span) span.dataset.flashDisabled = (status === 'On Hold' || status === 'Done') ? 'true' : 'false';
        const prioSel = tr.querySelector('select.task-priority, select.subtask-priority');
        if (prioSel) {
          const td = prioSel.closest('td'); td.classList.remove('priority-low','priority-medium','priority-high');
          if (prioSel.value === 'Low') td.classList.add('priority-low');
          else if (prioSel.value === 'Medium') td.classList.add('priority-medium');
          else if (prioSel.value === 'High') td.classList.add('priority-high');
        }
      });
    }

    function applyFlashes() {
      applyRowStyles();
      document.querySelectorAll('.days-left').forEach(span => {
        span.classList.remove('flash-warn','flash-alarm');
        if (span.dataset.flashDisabled === 'true') return;
        const d = parseInt(span.dataset.daysLeft, 10);
        if (d < alarmDays) span.classList.add('flash-alarm');
        else if (d < warnDays) span.classList.add('flash-warn');
      });
      updateDueSoonList(); updateTotalEstimate(); attachDaysLeftHandlers(); saveToStorage();
    }

    function updateTotalEstimate() {
      let tot = 0; document.querySelectorAll('td.task-estimate').forEach(td => { const v=parseInt(td.textContent,10); if(!isNaN(v)) tot+=v; });
      document.querySelectorAll('.estimate-total').forEach(c => c.textContent = tot);
    }

    function updateDueSoonList() {
      const tbody = document.querySelector('#dueSoonTable tbody'); tbody.innerHTML = ''; let cnt = 0;
      document.querySelectorAll('.task-row').forEach(tr => {
        const s = tr.querySelector('.days-left'); if (!s) return;
        const a = s.classList.contains('flash-alarm'), w = s.classList.contains('flash-warn');
        if (!a && !w) return;
        const r = document.createElement('tr'); r.style.backgroundColor = tr.style.backgroundColor;
        const c1 = r.insertCell(), c2 = r.insertCell(); c1.textContent = tr.cells[1].textContent;
        const sp = document.createElement('span'); sp.textContent = s.dataset.daysLeft+'d'; sp.dataset.daysLeft = s.dataset.daysLeft; sp.dataset.flashDisabled = s.dataset.flashDisabled;
        sp.style.cursor = 'default'; a?sp.classList.add('flash-alarm'):sp.classList.add('flash-warn'); c2.appendChild(sp);
        tbody.appendChild(r); cnt++;
      });
      dueToggle.textContent = `Tasks Due Soon (${cnt})`;
      dueToggle.classList.toggle('flash-alarm', !!document.querySelector('#dueSoonTable .flash-alarm')); 
      dueToggle.classList.toggle('flash-warn',  !document.querySelector('#dueSoonTable .flash-alarm') && !!document.querySelector('#dueSoonTable .flash-warn'));
    }

    dueToggle.addEventListener('click', () => duePanel.classList.toggle('open'));

    document.getElementById('newProjectBtn').addEventListener('click', createProject);
    function createProject() {
      const proj = document.createElement('div'); proj.className = 'project-container';
      proj.innerHTML = `
        <div class="project-header">
          <h2 contenteditable class="project-title">New Project</h2>
          <button class="delete-btn">Delete Project</button>
        </div>
        <table>
          <thead><tr><th></th><th>Task</th><th>Due Date</th><th>Status</th><th>Priority</th><th>Estimated Hours</th><th>Notes</th><th>Days Left</th><th>Actions</th></tr></thead>
          <tbody class="task-body"></tbody>
          <tfoot><tr class="estimate-total-row"><td colspan="5" style="text-align:right">Total Estimated Hours:</td><td class="estimate-total">0</td><td colspan="2"></td><td></td></tr>
            <tr class="new-task-row"><td></td><td><input type="text" class="new-task-name" placeholder="Task Name"></td><td><input type="date" class="new-task-date"></td><td><select class="new-task-status"><option>Not Started</option><option>In Progress</option><option>Done</option><option>On Hold</option></select></td><td><select class="new-task-priority"><option>Low</option><option>Medium</option><option>High</option></select></td><td><input type="number" class="new-task-estimate" min="0" step="1" placeholder="Hours"></td><td><input type="text" class="new-task-notes" placeholder="Notes"></td><td></td><td><button class="add-task-btn">Add</button></td></tr>
          </tfoot>
        </table>
      `;
      projectsDiv.appendChild(proj);
      proj.querySelector('.delete-btn').onclick = () => {
        if (confirm('Are you sure you want to delete this project?')) { proj.remove(); applyFlashes(); }
      };
      proj.querySelector('.add-task-btn').onclick = e => { e.preventDefault(); addTask(proj); };
    }

    function addTask(proj, data) {
      const name     = data?.name     || proj.querySelector('.new-task-name').value.trim();
      const date     = data?.due      || proj.querySelector('.new-task-date').value;
      if (!name || !date) return alert('Task name and due date required');
      const status   = data?.status   || proj.querySelector('.new-task-status').value;
      const priority = data?.priority || proj.querySelector('.new-task-priority').value;
      const estimate = data?.estimate || proj.querySelector('.new-task-estimate').value;
      const notes    = data?.notes    || proj.querySelector('.new-task-notes').value.trim();
      const dl       = daysLeft(date);
      const tr = document.createElement('tr'); tr.className = 'task-row'; tr.draggable = true;
      const hue = data?.hue ?? getUniqueHue(); tr.dataset.hue = hue; tr.style.backgroundColor = `hsl(${hue},70%,90%)`;
      tr.innerHTML = `
        <td class="drag-handle">↕</td><td contenteditable>${name}</td><td><input type="date" value="${date}"></td>
        <td><select class="task-status"><option${status==='Not Started'?' selected':''}>Not Started</option><option${status==='In Progress'?' selected':''}>In Progress</option><option${status==='Done'?' selected':''}>Done</option><option${status==='On Hold'?' selected':''}>On Hold</option></select></td>
        <td><select class="task-priority"><option${priority==='Low'?' selected':''}>Low</option><option${priority==='Medium'?' selected':''}>Medium</option><option${priority==='High'?' selected':''}>High</option></select></td>
        <td contenteditable class="task-estimate">${estimate}</td><td contenteditable>${notes}</td>
        <td><span class="days-left" data-days-left="${dl}" data-flash-disabled="false">${dl}d</span></td>
        <td><button class="toggle-btn">Show Subtasks</button> <button class="delete-btn">Delete</button></td>
      `;
      const sr = document.createElement('tr'); sr.className = 'subtask-container'; sr.style.display = 'none';
      sr.innerHTML = `
        <td colspan="9">
          <table><thead><tr><th>Subtask</th><th>Due Date</th><th>Status</th><th>Priority</th><th>Notes</th><th>Days Left</th><th>Actions</th></tr></thead>
          <tbody class="subtask-body"></tbody><tfoot><tr><td><input type="text" class="subtask-name" placeholder="Subtask"></td><td><input type="date" class="subtask-date"></td><td><select class="subtask-status"><option>Not Started</option><option>In Progress</option><option>Done</option><option>On Hold</option></select></td><td><select class="subtask-priority"><option>Low</option><option>Medium</option><option>High</option></select></td><td><input type="text" class="subtask-notes" placeholder="Notes"></td><td></td><td><button class="add-subtask-btn">Add</button></td></tr></tfoot></table>
        </td>
      `;
      proj.querySelector('.task-body').appendChild(tr); proj.querySelector('.task-body').appendChild(sr);
      tr.querySelector('.delete-btn').onclick = () => {
        if (confirm('Are you sure you want to delete this task?')) { tr.remove(); sr.remove(); applyFlashes(); }
      };
      tr.querySelector('.toggle-btn').onclick = () => { const o = sr.style.display===''; sr.style.display = o?'none':''; tr.querySelector('.toggle-btn').textContent = o?'Show Subtasks':'Hide Subtasks'; };
      tr.querySelector('select.task-status').onchange   = applyFlashes;
      tr.querySelector('select.task-priority').onchange = applyFlashes;
      tr.querySelector('td.task-estimate').addEventListener('input', applyFlashes);
      tr.querySelector('input[type="date"]').onchange = e => { const s=tr.querySelector('.days-left'); const nd=daysLeft(e.target.value); s.dataset.daysLeft = nd; s.textContent = nd+'d'; applyFlashes(); };
      const loadSub = t => {
        const srow = document.createElement('tr'); srow.className = 'subtask-entry'; srow.style.backgroundColor = `hsl(${hue},70%,95%)`;
        const sdl = daysLeft(t.due);
        srow.innerHTML = `
          <td contenteditable>${t.name}</td><td><input type="date" value="${t.due}"></td>
          <td><select class="subtask-status"><option${t.status==='Not Started'?' selected':''}>Not Started</option><option${t.status==='In Progress'?' selected':''}>In Progress</option><option${t.status==='Done'?' selected':''}>Done</option><option${t.status==='On Hold'?' selected':''}>On Hold</option></select></td>
          <td><select class="subtask-priority"><option${t.priority==='Low'?' selected':''}>Low</option><option${t.priority==='Medium'?' selected':''}>Medium</option><option${t.priority==='High'?' selected':''}>High</option></select></td>\<td contenteditable>${t.notes}</td>
          <td><span class="days-left" data-days-left="${sdl}" data-flash-disabled="false">${sdl}d</span></td><td><button class="delete-btn">Delete</button></td>
        `;
        srow.querySelector('.delete-btn').onclick = () => {
          if (confirm('Are you sure you want to delete this subtask?')) { srow.remove(); applyFlashes(); }
        };
        srow.querySelector('select.subtask-status').onchange   = applyFlashes;
        srow.querySelector('select.subtask-priority').onchange = applyFlashes;
        srow.querySelector('input[type="date"]').onchange = e => { const sp=srow.querySelector('.days-left'); const nd2=daysLeft(e.target.value); sp.dataset.daysLeft=nd2; sp.textContent=nd2+'d'; applyFlashes(); };
        sr.querySelector('.subtask-body').appendChild(srow);
      };
      if (data?.subtasks) data.subtasks.forEach(loadSub);
      sr.querySelector('.add-subtask-btn').onclick = e => { e.preventDefault(); const sn=sr.querySelector('.subtask-name').value.trim(); const sd=sr.querySelector('.subtask-date').value; if(!sn||!sd) return alert('Subtask name and date required'); loadSub({name:sn,due:sd,status:sr.querySelector('.subtask-status').value,priority:sr.querySelector('.subtask-priority').value,notes:sr.querySelector('.subtask-notes').value.trim()}); sr.querySelector('.subtask-name').value=''; sr.querySelector('.subtask-date').value=''; sr.querySelector('.subtask-status').selectedIndex=0; sr.querySelector('.subtask-priority').selectedIndex=0; sr.querySelector('.subtask-notes').value=''; applyFlashes(); };
      proj.querySelector('.new-task-name').value=''; proj.querySelector('.new-task-date').value=''; proj.querySelector('.new-task-status').selectedIndex=0; proj.querySelector('.new-task-priority').selectedIndex=0; proj.querySelector('.new-task-estimate').value=''; proj.querySelector('.new-task-notes').value='';
      applyFlashes();
    }
    window.addEventListener('load', ()=>{ loadFromStorage(); applyFlashes(); });
  </script>
</body>
</html>
